function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var e,n={exports:{}},i="object"==typeof Reflect?Reflect:null,r=i&&"function"==typeof i.apply?i.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};e=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var s=Number.isNaN||function(t){return t!=t};function o(){o.init.call(this)}n.exports=o,n.exports.once=function(t,e){return new Promise(function(n,i){function r(n){t.removeListener(e,s),i(n)}function s(){"function"==typeof t.removeListener&&t.removeListener("error",r),n([].slice.call(arguments))}v(t,e,s,{once:!0}),"error"!==e&&function(t,e,n){"function"==typeof t.on&&v(t,"error",e,n)}(t,r,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function c(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function u(t){return void 0===t._maxListeners?o.defaultMaxListeners:t._maxListeners}function h(t,e,n,i){var r,s,o,a;if(c(n),void 0===(s=t._events)?(s=t._events=Object.create(null),t._eventsCount=0):(void 0!==s.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),s=t._events),o=s[e]),void 0===o)o=s[e]=n,++t._eventsCount;else if("function"==typeof o?o=s[e]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),(r=u(t))>0&&o.length>r&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=e,h.count=o.length,a=h,console&&console.warn&&console.warn(a)}return t}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(t,e,n){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},r=l.bind(i);return r.listener=n,i.wrapFn=r,r}function p(t,e,n){var i=t._events;if(void 0===i)return[];var r=i[e];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(r):y(r,r.length)}function d(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function y(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}function v(t,e,n,i){if("function"==typeof t.on)i.once?t.once(e,n):t.on(e,n);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,function r(s){i.once&&t.removeEventListener(e,r),n(s)})}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");a=t}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},o.prototype.getMaxListeners=function(){return u(this)},o.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i="error"===t,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(void 0===c)return!1;if("function"==typeof c)r(c,this,e);else{var u=c.length,h=y(c,u);for(n=0;n<u;++n)r(h[n],this,e)}return!0},o.prototype.addListener=function(t,e){return h(this,t,e,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(t,e){return h(this,t,e,!0)},o.prototype.once=function(t,e){return c(e),this.on(t,f(this,t,e)),this},o.prototype.prependOnceListener=function(t,e){return c(e),this.prependListener(t,f(this,t,e)),this},o.prototype.removeListener=function(t,e){var n,i,r,s,o;if(c(e),void 0===(i=this._events))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0===--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,s=n.length-1;s>=0;s--)if(n[s]===e||n[s].listener===e){o=n[s].listener,r=s;break}if(r<0)return this;0===r?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,r),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,o||e)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(t){var e,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var r,s=Object.keys(n);for(i=0;i<s.length;++i)"removeListener"!==(r=s[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;i>=0;i--)this.removeListener(t,e[i]);return this},o.prototype.listeners=function(t){return p(this,t,!0)},o.prototype.rawListeners=function(t){return p(this,t,!1)},o.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):d.call(t,e)},o.prototype.listenerCount=d,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]};var g=n.exports,m={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,n="~";function i(){}function r(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function s(t,e,i,s,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new r(i,s||t,o),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function o(t,e){0===--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),a.prototype.eventNames=function(){var t,i,r=[];if(0===this._eventsCount)return r;for(i in t=this._events)e.call(t,i)&&r.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},a.prototype.listeners=function(t){var e=n?n+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,s=i.length,o=new Array(s);r<s;r++)o[r]=i[r].fn;return o},a.prototype.listenerCount=function(t){var e=n?n+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,r,s,o){var a=n?n+t:t;if(!this._events[a])return!1;var c,u,h=this._events[a],l=arguments.length;if(h.fn){switch(h.once&&this.removeListener(t,h.fn,void 0,!0),l){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,e),!0;case 3:return h.fn.call(h.context,e,i),!0;case 4:return h.fn.call(h.context,e,i,r),!0;case 5:return h.fn.call(h.context,e,i,r,s),!0;case 6:return h.fn.call(h.context,e,i,r,s,o),!0}for(u=1,c=new Array(l-1);u<l;u++)c[u-1]=arguments[u];h.fn.apply(h.context,c)}else{var f,p=h.length;for(u=0;u<p;u++)switch(h[u].once&&this.removeListener(t,h[u].fn,void 0,!0),l){case 1:h[u].fn.call(h[u].context);break;case 2:h[u].fn.call(h[u].context,e);break;case 3:h[u].fn.call(h[u].context,e,i);break;case 4:h[u].fn.call(h[u].context,e,i,r);break;default:if(!c)for(f=1,c=new Array(l-1);f<l;f++)c[f-1]=arguments[f];h[u].fn.apply(h[u].context,c)}}return!0},a.prototype.on=function(t,e,n){return s(this,t,e,n,!1)},a.prototype.once=function(t,e,n){return s(this,t,e,n,!0)},a.prototype.removeListener=function(t,e,i,r){var s=n?n+t:t;if(!this._events[s])return this;if(!e)return o(this,s),this;var a=this._events[s];if(a.fn)a.fn!==e||r&&!a.once||i&&a.context!==i||o(this,s);else{for(var c=0,u=[],h=a.length;c<h;c++)(a[c].fn!==e||r&&!a[c].once||i&&a[c].context!==i)&&u.push(a[c]);u.length?this._events[s]=1===u.length?u[0]:u:o(this,s)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&o(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a}(m);var w=t(m.exports);class b extends Error{constructor(t,e,n){super(e),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:n}),this.name="OneKeyError"}}class _ extends b{constructor(t,e,n,i){super(n,t,i),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:e}),this.name="ApiError"}}class A extends b{constructor(t,e){super("NETWORK_ERROR",t,e),this.name="NetworkError"}}class O extends b{constructor(t,e){super("AUTHENTICATION_FAILED",t,e),this.name="AuthenticationError"}}class C extends b{constructor(t,e){super("VALIDATION_ERROR",t,e),this.name="ValidationError"}}class L extends w{constructor(t){super(),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"accessToken",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.config={apiKey:t.apiKey,environment:t.environment,baseUrl:t.baseUrl||this.getDefaultBaseUrl(t.environment),timeout:t.timeout||3e4,retryAttempts:t.retryAttempts||3,headers:t.headers||{},debug:t.debug||!1,retry:t.retry||{attempts:3,delay:1e3,backoff:"exponential"}},this.validateConfig()}validateConfig(){if(!this.config.apiKey)throw new C("API key is required");if(this.config.apiKey.length<10)throw new C("Invalid API key format")}getDefaultBaseUrl(t){return"sandbox"===t?"https://api-sandbox.onekey.so/v1":"https://api.onekey.so/v1"}setAccessToken(t){this.accessToken=t,this.emit("token:set",t)}clearAccessToken(){this.accessToken=null,this.emit("token:cleared")}getAccessToken(){return this.accessToken}async authenticate(){var t;try{this.config.debug&&console.log("[OneKey SDK] Authenticating with API key...");const e=await this.request({method:"POST",endpoint:"/auth/login",data:{apiKey:this.config.apiKey},skipAuth:!0});if(!(null===(t=e.data)||void 0===t?void 0:t.token))throw new O("No token received from authentication");return this.setAccessToken(e.data.token),this.config.debug&&console.log("[OneKey SDK] Authentication successful"),e.data.token}catch(t){throw this.config.debug&&console.error("[OneKey SDK] Authentication failed:",t),new O("Authentication failed",{originalError:t instanceof Error?t.message:String(t)})}}async request(t){const{method:e,endpoint:n,data:i,params:r,headers:s={},timeout:o,skipAuth:a=!1}=t,c=`${this.config.baseUrl}${n}`,u={"Content-Type":"application/json","User-Agent":"OneKey-SDK/1.0.0",...this.config.headers,...s};!a&&this.accessToken&&(u.Authorization=`Bearer ${this.accessToken}`);const h=r?`${c}?${new URLSearchParams(r).toString()}`:c,l={method:e,headers:u,signal:AbortSignal.timeout(o||this.config.timeout)};return i&&"GET"!==e&&(l.body=JSON.stringify(i)),this.config.debug&&console.log(`[OneKey SDK] ${e} ${h}`,{headers:u,data:i}),this.executeWithRetry(h,l)}async executeWithRetry(t,e){let n=null;for(let i=1;i<=this.config.retry.attempts;i++)try{const n=await fetch(t,e),r=await this.handleResponse(n);return this.config.debug&&i>1&&console.log(`[OneKey SDK] Request succeeded on attempt ${i}`),r}catch(t){if(n=t instanceof Error?t:new Error(String(t)),t instanceof O||t instanceof C)throw t;if(t instanceof _&&t.status>=400&&t.status<500&&429!==t.status)throw t;if(i<this.config.retry.attempts){const e=this.calculateRetryDelay(i);this.config.debug&&console.log(`[OneKey SDK] Request failed (attempt ${i}), retrying in ${e}ms...`,t),await this.sleep(e)}}throw n||new A("Request failed after all retry attempts")}async handleResponse(t){var e,n,i,r,s,o;let a;try{a=await t.json()}catch(t){throw new A("Invalid JSON response from server")}if(this.config.debug&&console.log("[OneKey SDK] Response:",{status:t.status,data:a}),!t.ok){const r=(null===(e=null==a?void 0:a.error)||void 0===e?void 0:e.code)||"UNKNOWN_ERROR",s=(null===(n=null==a?void 0:a.error)||void 0===n?void 0:n.message)||`HTTP ${t.status} Error`,o=null===(i=null==a?void 0:a.error)||void 0===i?void 0:i.details;if(401===t.status)throw this.clearAccessToken(),new O(s,o);if(400===t.status)throw new C(s,o);throw new _(s,t.status,r,o)}if(!a.success)throw new b((null===(r=a.error)||void 0===r?void 0:r.message)||"API request failed",(null===(s=a.error)||void 0===s?void 0:s.code)||"API_ERROR",null===(o=a.error)||void 0===o?void 0:o.details);return a}calculateRetryDelay(t){const e=this.config.retry.delay;return"exponential"===this.config.retry.backoff?e*Math.pow(2,t-1):e*t}sleep(t){return new Promise(e=>setTimeout(e,t))}async get(t,e,n){return this.request({method:"GET",endpoint:t,params:e,...n})}async post(t,e,n){return this.request({method:"POST",endpoint:t,data:e,...n})}async patch(t,e,n){return this.request({method:"PATCH",endpoint:t,data:e,...n})}async put(t,e,n){return this.request({method:"PUT",endpoint:t,data:e,...n})}async delete(t,e){return this.request({method:"DELETE",endpoint:t,...e})}destroy(){this.removeAllListeners(),this.accessToken=null}updateConfig(t){Object.assign(this.config,t),t.baseUrl&&(this.config.baseUrl=t.baseUrl),this.emit("config:updated",this.config)}getConfig(){return{...this.config}}}class x extends g.EventEmitter{constructor(t){super(),Object.defineProperty(this,"httpClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.config=this.validateConfig(t),this.httpClient=new L(this.config),this.httpClient.on("token:refreshed",t=>{this.emit("auth:token:refreshed",t)}),this.httpClient.on("token:expired",()=>{this.emit("auth:token:expired")}),this.httpClient.on("error",t=>{this.emit("error",t)})}async initialize(){if(!this.isInitialized)try{if("ok"!==(await this.httpClient.get("/health")).status)throw new b("SDK_INITIALIZATION_FAILED","Service health check failed");this.config.apiKey&&await this.validateApiKey(),this.isInitialized=!0,this.emit("initialized")}catch(t){const e=t instanceof b?t:new b("SDK_INITIALIZATION_FAILED","Failed to initialize SDK",t);throw this.emit("error",e),e}}async authenticate(t){this.config.apiKey=t,this.httpClient.updateConfig(this.config);try{await this.validateApiKey(),this.emit("auth:authenticated")}catch(t){const e=t instanceof b?t:new b("AUTHENTICATION_FAILED","API key authentication failed",t);throw this.emit("auth:failed",e),e}}getConfig(){return{...this.config}}updateConfig(t){this.config={...this.config,...t},this.httpClient.updateConfig(this.config),this.emit("config:updated",this.config)}get initialized(){return this.isInitialized}async getKycProviders(){return(await this.httpClient.get("/kyc/providers")).data}async createKycSession(t,e={}){return(await this.httpClient.post("/kyc/session",{provider:t,...e})).data}async getKycSession(t){return(await this.httpClient.get(`/kyc/session/${t}`)).data}async uploadKycDocument(t,e,n,i={}){const r=new FormData;if(r.append("documentType",e),r.append("sessionId",t),n instanceof File)r.append("document",n,i.filename||n.name);else{const t=new Blob([n]);r.append("document",t,i.filename||"document")}i.metadata&&r.append("metadata",JSON.stringify(i.metadata));return(await this.httpClient.post("/kyc/document/upload",r,{headers:{"Content-Type":"multipart/form-data"}})).data}async getKycStatus(t){return(await this.httpClient.get(`/kyc/status/${t}`)).data}async getAttestationSchemas(){return(await this.httpClient.get("/attestations/schemas")).data}async createAttestation(t,e,n,i={}){return(await this.httpClient.post("/attestations",{schemaId:t,recipient:e,data:n,...i})).data}async getAttestation(t){return(await this.httpClient.get(`/attestations/${t}`)).data}async queryAttestations(t){const e=new URLSearchParams;Object.entries(t).forEach(([t,n])=>{void 0!==n&&e.append(t,n.toString())});return(await this.httpClient.get(`/attestations/query?${e.toString()}`)).data}async revokeAttestation(t,e){await this.httpClient.post(`/attestations/${t}/revoke`,{reason:e})}async verifyAttestation(t){return(await this.httpClient.get(`/attestations/${t}/verify`)).data}async getCryptoProviders(){return(await this.httpClient.get("/crypto/providers")).data}async encryptData(t,e={}){const n="string"==typeof t?t:JSON.stringify(t);return(await this.httpClient.post("/crypto/encrypt",{data:n,...e})).data}async decryptData(t,e,n={}){return(await this.httpClient.post("/crypto/decrypt",{encrypted:t,keyId:e,...n})).data.decrypted}async storeData(t,e={}){const n="string"==typeof t?t:JSON.stringify(t);return(await this.httpClient.post("/storage/store",{data:n,...e})).data}async retrieveData(t,e={}){return(await this.httpClient.get(`/storage/retrieve/${t}`,{params:e})).data.data}validateConfig(t){if(!t.environment)throw new b("INVALID_CONFIG","Environment is required");if(!["production","sandbox"].includes(t.environment))throw new b("INVALID_CONFIG",'Environment must be "production" or "sandbox"');return{retryAttempts:3,timeout:3e4,...t}}async validateApiKey(){if(!this.config.apiKey)throw new b("AUTHENTICATION_FAILED","API key is required");try{await this.httpClient.get("/auth/validate")}catch(t){throw new b("AUTHENTICATION_FAILED","Invalid API key",t)}}destroy(){this.removeAllListeners(),this.httpClient.destroy(),this.isInitialized=!1}}function E(t){return new x(t)}export{L as HttpClient,x as OneKeySDK,E as createOneKeySDK};
//# sourceMappingURL=index.esm.js.map
