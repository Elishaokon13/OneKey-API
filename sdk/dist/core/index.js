"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t,n={exports:{}},i="object"==typeof Reflect?Reflect:null,r=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}n.exports=o,n.exports.once=function(e,t){return new Promise(function(n,i){function r(n){e.removeListener(t,s),i(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",r),n([].slice.call(arguments))}v(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&v(e,"error",t,n)}(e,r,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function h(e,t,n,i){var r,s,o,a;if(c(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),(r=u(e))>0&&o.length>r&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=o.length,a=h,console&&console.warn&&console.warn(a)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=l.bind(i);return r.listener=n,i.wrapFn=r,r}function p(e,t,n){var i=e._events;if(void 0===i)return[];var r=i[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):y(r,r.length)}function d(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function y(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function v(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function r(s){i.once&&e.removeEventListener(t,r),n(s)})}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return u(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var u=c.length,h=y(c,u);for(n=0;n<u;++n)r(h[n],this,t)}return!0},o.prototype.addListener=function(e,t){return h(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return h(this,e,t,!0)},o.prototype.once=function(e,t){return c(t),this.on(e,f(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,f(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,i,r,s,o;if(c(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,r=s;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,s=Object.keys(n);for(i=0;i<s.length;++i)"removeListener"!==(r=s[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},o.prototype.listeners=function(e){return p(this,e,!0)},o.prototype.rawListeners=function(e){return p(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},o.prototype.listenerCount=d,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};var g=n.exports,m={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function i(){}function r(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,i,s,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new r(i,s||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0===--e._eventsCount?e._events=new i:delete e._events[t]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,i,r=[];if(0===this._eventsCount)return r;for(i in e=this._events)t.call(e,i)&&r.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},a.prototype.listeners=function(e){var t=n?n+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,s=i.length,o=new Array(s);r<s;r++)o[r]=i[r].fn;return o},a.prototype.listenerCount=function(e){var t=n?n+e:e,i=this._events[t];return i?i.fn?1:i.length:0},a.prototype.emit=function(e,t,i,r,s,o){var a=n?n+e:e;if(!this._events[a])return!1;var c,u,h=this._events[a],l=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),l){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,i),!0;case 4:return h.fn.call(h.context,t,i,r),!0;case 5:return h.fn.call(h.context,t,i,r,s),!0;case 6:return h.fn.call(h.context,t,i,r,s,o),!0}for(u=1,c=new Array(l-1);u<l;u++)c[u-1]=arguments[u];h.fn.apply(h.context,c)}else{var f,p=h.length;for(u=0;u<p;u++)switch(h[u].once&&this.removeListener(e,h[u].fn,void 0,!0),l){case 1:h[u].fn.call(h[u].context);break;case 2:h[u].fn.call(h[u].context,t);break;case 3:h[u].fn.call(h[u].context,t,i);break;case 4:h[u].fn.call(h[u].context,t,i,r);break;default:if(!c)for(f=1,c=new Array(l-1);f<l;f++)c[f-1]=arguments[f];h[u].fn.apply(h[u].context,c)}}return!0},a.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,i,r){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return o(this,s),this;var a=this._events[s];if(a.fn)a.fn!==t||r&&!a.once||i&&a.context!==i||o(this,s);else{for(var c=0,u=[],h=a.length;c<h;c++)(a[c].fn!==t||r&&!a[c].once||i&&a[c].context!==i)&&u.push(a[c]);u.length?this._events[s]=1===u.length?u[0]:u:o(this,s)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a}(m);var w=e(m.exports);class b extends Error{constructor(e,t,n){super(t),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:n}),this.name="OneKeyError"}}class _ extends b{constructor(e,t,n,i){super(n,e,i),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:t}),this.name="ApiError"}}class O extends b{constructor(e,t){super("NETWORK_ERROR",e,t),this.name="NetworkError"}}class A extends b{constructor(e,t){super("AUTHENTICATION_FAILED",e,t),this.name="AuthenticationError"}}class C extends b{constructor(e,t){super("VALIDATION_ERROR",e,t),this.name="ValidationError"}}class L extends w{constructor(e){super(),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"accessToken",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.config={apiKey:e.apiKey,environment:e.environment,baseUrl:e.baseUrl||this.getDefaultBaseUrl(e.environment),timeout:e.timeout||3e4,retryAttempts:e.retryAttempts||3,headers:e.headers||{},debug:e.debug||!1,retry:e.retry||{attempts:3,delay:1e3,backoff:"exponential"}},this.validateConfig()}validateConfig(){if(!this.config.apiKey)throw new C("API key is required");if(this.config.apiKey.length<10)throw new C("Invalid API key format")}getDefaultBaseUrl(e){return"sandbox"===e?"https://api-sandbox.onekey.so/v1":"https://api.onekey.so/v1"}setAccessToken(e){this.accessToken=e,this.emit("token:set",e)}clearAccessToken(){this.accessToken=null,this.emit("token:cleared")}getAccessToken(){return this.accessToken}async authenticate(){var e;try{this.config.debug&&console.log("[OneKey SDK] Authenticating with API key...");const t=await this.request({method:"POST",endpoint:"/auth/login",data:{apiKey:this.config.apiKey},skipAuth:!0});if(!(null===(e=t.data)||void 0===e?void 0:e.token))throw new A("No token received from authentication");return this.setAccessToken(t.data.token),this.config.debug&&console.log("[OneKey SDK] Authentication successful"),t.data.token}catch(e){throw this.config.debug&&console.error("[OneKey SDK] Authentication failed:",e),new A("Authentication failed",{originalError:e instanceof Error?e.message:String(e)})}}async request(e){const{method:t,endpoint:n,data:i,params:r,headers:s={},timeout:o,skipAuth:a=!1}=e,c=`${this.config.baseUrl}${n}`,u={"Content-Type":"application/json","User-Agent":"OneKey-SDK/1.0.0",...this.config.headers,...s};!a&&this.accessToken&&(u.Authorization=`Bearer ${this.accessToken}`);const h=r?`${c}?${new URLSearchParams(r).toString()}`:c,l={method:t,headers:u,signal:AbortSignal.timeout(o||this.config.timeout)};return i&&"GET"!==t&&(l.body=JSON.stringify(i)),this.config.debug&&console.log(`[OneKey SDK] ${t} ${h}`,{headers:u,data:i}),this.executeWithRetry(h,l)}async executeWithRetry(e,t){let n=null;for(let i=1;i<=this.config.retry.attempts;i++)try{const n=await fetch(e,t),r=await this.handleResponse(n);return this.config.debug&&i>1&&console.log(`[OneKey SDK] Request succeeded on attempt ${i}`),r}catch(e){if(n=e instanceof Error?e:new Error(String(e)),e instanceof A||e instanceof C)throw e;if(e instanceof _&&e.status>=400&&e.status<500&&429!==e.status)throw e;if(i<this.config.retry.attempts){const t=this.calculateRetryDelay(i);this.config.debug&&console.log(`[OneKey SDK] Request failed (attempt ${i}), retrying in ${t}ms...`,e),await this.sleep(t)}}throw n||new O("Request failed after all retry attempts")}async handleResponse(e){var t,n,i,r,s,o;let a;try{a=await e.json()}catch(e){throw new O("Invalid JSON response from server")}if(this.config.debug&&console.log("[OneKey SDK] Response:",{status:e.status,data:a}),!e.ok){const r=(null===(t=null==a?void 0:a.error)||void 0===t?void 0:t.code)||"UNKNOWN_ERROR",s=(null===(n=null==a?void 0:a.error)||void 0===n?void 0:n.message)||`HTTP ${e.status} Error`,o=null===(i=null==a?void 0:a.error)||void 0===i?void 0:i.details;if(401===e.status)throw this.clearAccessToken(),new A(s,o);if(400===e.status)throw new C(s,o);throw new _(s,e.status,r,o)}if(!a.success)throw new b((null===(r=a.error)||void 0===r?void 0:r.message)||"API request failed",(null===(s=a.error)||void 0===s?void 0:s.code)||"API_ERROR",null===(o=a.error)||void 0===o?void 0:o.details);return a}calculateRetryDelay(e){const t=this.config.retry.delay;return"exponential"===this.config.retry.backoff?t*Math.pow(2,e-1):t*e}sleep(e){return new Promise(t=>setTimeout(t,e))}async get(e,t,n){return this.request({method:"GET",endpoint:e,params:t,...n})}async post(e,t,n){return this.request({method:"POST",endpoint:e,data:t,...n})}async patch(e,t,n){return this.request({method:"PATCH",endpoint:e,data:t,...n})}async put(e,t,n){return this.request({method:"PUT",endpoint:e,data:t,...n})}async delete(e,t){return this.request({method:"DELETE",endpoint:e,...t})}destroy(){this.removeAllListeners(),this.accessToken=null}updateConfig(e){Object.assign(this.config,e),e.baseUrl&&(this.config.baseUrl=e.baseUrl),this.emit("config:updated",this.config)}getConfig(){return{...this.config}}}class x extends g.EventEmitter{constructor(e){super(),Object.defineProperty(this,"httpClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.config=this.validateConfig(e),this.httpClient=new L(this.config),this.httpClient.on("token:refreshed",e=>{this.emit("auth:token:refreshed",e)}),this.httpClient.on("token:expired",()=>{this.emit("auth:token:expired")}),this.httpClient.on("error",e=>{this.emit("error",e)})}async initialize(){if(!this.isInitialized)try{if("ok"!==(await this.httpClient.get("/health")).status)throw new b("SDK_INITIALIZATION_FAILED","Service health check failed");this.config.apiKey&&await this.validateApiKey(),this.isInitialized=!0,this.emit("initialized")}catch(e){const t=e instanceof b?e:new b("SDK_INITIALIZATION_FAILED","Failed to initialize SDK",e);throw this.emit("error",t),t}}async authenticate(e){this.config.apiKey=e,this.httpClient.updateConfig(this.config);try{await this.validateApiKey(),this.emit("auth:authenticated")}catch(e){const t=e instanceof b?e:new b("AUTHENTICATION_FAILED","API key authentication failed",e);throw this.emit("auth:failed",t),t}}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},this.httpClient.updateConfig(this.config),this.emit("config:updated",this.config)}get initialized(){return this.isInitialized}async getKycProviders(){return(await this.httpClient.get("/kyc/providers")).data}async createKycSession(e,t={}){return(await this.httpClient.post("/kyc/session",{provider:e,...t})).data}async getKycSession(e){return(await this.httpClient.get(`/kyc/session/${e}`)).data}async uploadKycDocument(e,t,n,i={}){const r=new FormData;if(r.append("documentType",t),r.append("sessionId",e),n instanceof File)r.append("document",n,i.filename||n.name);else{const e=new Blob([n]);r.append("document",e,i.filename||"document")}i.metadata&&r.append("metadata",JSON.stringify(i.metadata));return(await this.httpClient.post("/kyc/document/upload",r,{headers:{"Content-Type":"multipart/form-data"}})).data}async getKycStatus(e){return(await this.httpClient.get(`/kyc/status/${e}`)).data}async getAttestationSchemas(){return(await this.httpClient.get("/attestations/schemas")).data}async createAttestation(e,t,n,i={}){return(await this.httpClient.post("/attestations",{schemaId:e,recipient:t,data:n,...i})).data}async getAttestation(e){return(await this.httpClient.get(`/attestations/${e}`)).data}async queryAttestations(e){const t=new URLSearchParams;Object.entries(e).forEach(([e,n])=>{void 0!==n&&t.append(e,n.toString())});return(await this.httpClient.get(`/attestations/query?${t.toString()}`)).data}async revokeAttestation(e,t){await this.httpClient.post(`/attestations/${e}/revoke`,{reason:t})}async verifyAttestation(e){return(await this.httpClient.get(`/attestations/${e}/verify`)).data}async getCryptoProviders(){return(await this.httpClient.get("/crypto/providers")).data}async encryptData(e,t={}){const n="string"==typeof e?e:JSON.stringify(e);return(await this.httpClient.post("/crypto/encrypt",{data:n,...t})).data}async decryptData(e,t,n={}){return(await this.httpClient.post("/crypto/decrypt",{encrypted:e,keyId:t,...n})).data.decrypted}async storeData(e,t={}){const n="string"==typeof e?e:JSON.stringify(e);return(await this.httpClient.post("/storage/store",{data:n,...t})).data}async retrieveData(e,t={}){return(await this.httpClient.get(`/storage/retrieve/${e}`,{params:t})).data.data}validateConfig(e){if(!e.environment)throw new b("INVALID_CONFIG","Environment is required");if(!["production","sandbox"].includes(e.environment))throw new b("INVALID_CONFIG",'Environment must be "production" or "sandbox"');return{retryAttempts:3,timeout:3e4,...e}}async validateApiKey(){if(!this.config.apiKey)throw new b("AUTHENTICATION_FAILED","API key is required");try{await this.httpClient.get("/auth/validate")}catch(e){throw new b("AUTHENTICATION_FAILED","Invalid API key",e)}}destroy(){this.removeAllListeners(),this.httpClient.destroy(),this.isInitialized=!1}}exports.HttpClient=L,exports.OneKeySDK=x,exports.createOneKeySDK=function(e){return new x(e)};
//# sourceMappingURL=index.js.map
